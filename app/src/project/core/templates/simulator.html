{% load crispy_forms_tags %}

<!DOCTYPE html>
<html>
<head>
  <title>Yuma Simulation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.min.js" integrity="sha384-VQqxDN0EQCkWoxt/0vsQvZswzTHUVOImccYmSyhJTp7kGtPed0Qcx8rK9h9YEgx+" crossorigin="anonymous"></script>
<script
  src="https://code.jquery.com/jquery-3.7.1.min.js"
  integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
  crossorigin="anonymous"></script>
<!-- Latest compiled and minified CSS -->
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta2/dist/css/bootstrap-select.min.css"
/>

<!-- Latest compiled and minified JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta2/dist/js/bootstrap-select.min.js"></script>
</head>
<style>
/* Always hide form body on collapse */
#sidebar.collapsed .card-body {
  display: none !important;
}

/* On md+ screens, fully hide the sidebar when collapsed */
@media (min-width: 768px) {
  #sidebar.collapsed {
    display: none !important;
  }
}

/* Hide the “res-toggle” button by default */
.res-toggle {
  display: none !important;
}

/* On medium+ screens, show it only when the sidebar has the .collapsed class */
@media (min-width: 768px) {
  /* Assuming #sidebar and #results are siblings */
  #sidebar.collapsed + #results .res-toggle {
    display: inline-block !important;
  }
}

/* Make both toggles tiny so they don’t affect header height */
.sim-toggle,
.res-toggle {
  padding: 0.25rem !important;   /* minimal clickable area */
  width: 1.5rem;                 /* square button */
  height: 1.5rem;
  line-height: 1;                /* icon centers nicely */
  font-size: 1rem;               /* icon size */
}

/* If you want zero extra padding */
.sim-toggle,
.res-toggle {
  padding: 0 !important;
}

/* Optionally, use flex centering in case */
.sim-toggle i,
.res-toggle i {
  display: block;
  margin: auto;
}

/* Base: make all accordion buttons transparent */
.accordion-button {
  background-color: rgba(33, 37, 41, 0.05);
  color: inherit;
  box-shadow: none;
}

/* Expanded state: override Bootstrap’s default colored background */
.accordion-button:not(.collapsed) {
  background-color: rgba(33, 37, 41, 0.05);
  color: inherit;
  box-shadow: none;
}

/* 2) Bold your accordion headers */
.accordion-button {
  font-weight: 700;    /* Bootstrap “bold” */
}


#generateBtnHeader {
  padding: 0.25rem 0.5rem;   /* tighten padding */
  font-size: 0.75rem;        /* shrink font */
  line-height: 1;            /* remove extra height */
}

.fake-disabled {
  pointer-events: none;      /* no clicking or typing */
  opacity: 0.6;              /* greyed-out look */
  background-color: #e9ecef; /* match native disabled bg */
}


#chartWrapper {
  display: grid;
  gap: 2rem;                /* space between cards */
  align-items: start;       /* line up the tops */
}

/* smaller than 900px: let auto-fit do its thing (will only ever fit 1 column because 2×450px=900px) */
@media (max-width: 1349px) {
  #chartWrapper:not(.force-one) {
    grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
  }
}

/* 900px and up: exactly two columns */
@media (min-width: 1350px) {
  #chartWrapper:not(.force-one) {
    grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
  }
}

#chartWrapper.force-one {
  grid-template-columns: repeat(1, minmax(450px,1fr)) !important;
}

.case-container {
  margin-bottom: 2rem;  /* extra space below each chart/card */
  max-width: 1200px;
  width: 100%;
}

#chartWrapper.metagraph .case-container {
  max-width: none;    /* drop the 1200px cap */
  width: 100%;        /* span the full grid cell */
}

/* ----------------------------
   DESKTOP / LARGE (md+) 
   Sidebar “fixed” + self-scrolling
   ---------------------------- */
@media (min-width: 768px) {
  /* pin the sidebar to the left, full‐height */
  #sidebar {
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    width: 33%;            /* or whatever your grid uses (col-3 of 12 = 25%) */
    z-index: 100;          /* above page content, below modals/toolbars */
    overflow: visible;     /* let the card’s shadow show */
  }

  /* make the card fill that container*/
  #sidebar .card {
    height: 100%;
    display: flex;
    flex-direction: column;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1),
                0 2px 4px rgba(0,0,0,0.06);
  }

  /* only the body scrolls if content overflows */
  #sidebar .card-body {
    flex: 1 1 auto;
    overflow-y: auto;
  }
}

@media (min-width: 992px) {
  /* pin the sidebar to the left, full‐height */
  #sidebar {
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    width: 25%;            /* or whatever your grid uses (col-3 of 12 = 25%) */
    z-index: 100;          /* above page content, below modals/toolbars */
    overflow: visible;     /* let the card’s shadow show */
  }
}
/* ----------------------------
   MOBILE / SMALL (sm and down)
   Sidebar scrolls with page
   ---------------------------- */
@media (max-width: 767.98px) {
  #sidebar {
    position: static;      /* back to normal flow */
    width: 100%;
  }
  #sidebar .card {
    height: auto;
  }
  #sidebar .card-body {
    overflow-y: visible;   /* page handles scrolling */
  }
}


@media (min-width: 768px) {
  /* Define your sidebar width once */
  :root {
    --sidebar-width: 33%;   /* or whatever col-md-width you chose */
  }

  /* When sidebar is visible, push results over */
  #sidebar:not(.collapsed) ~ section,
  #sidebar:not(.collapsed) + .results-panel {
    margin-left: var(--sidebar-width);
    transition: margin-left 0.3s ease;
  }

  /* When sidebar is hidden (collapsed), reset margin */
  #sidebar.collapsed ~ section,
  #sidebar.collapsed + .results-panel {
    margin-left: 0;
  }
}

@media (min-width: 992px) {
  /* Define your sidebar width once */
  :root {
    --sidebar-width: 25%;   /* or whatever col-md-width you chose */
  }
}

</style>
<body>

  <div class="container-fluid">
    <div class="row gx-3">

      <!-- Input Panel -->
      <aside id="sidebar" class="col-12 col-md-4 col-lg-3 mb-4">
        <div class="card shadow h-100">
          <div class="card-header d-flex align-items-center justify-content-between"
               style="position: sticky; top: 0; z-index: 10; background: #f5f5f5;">
            <h5 class="mb-0">Yuma Simulation</h5>
            <!-- sim-toggle: always visible on small, only on md+ when expanded -->
            <button type="button"
                    class="sim-toggle btn btn-sm btn-outline-secondary"
                    aria-label="Toggle sidebar">
              <i class="bi bi-chevron-left"></i>
            </button>
          </div>
          <div class="card-body p-3">
            <form id="simulationForm"
                  method="get"
                  novalidate>

              <div class="accordion accordion-flush mt-4" id="paramsAccordion">

                <!-- Simulation Configuration (independent) -->
                <div class="accordion-item">
                  <h2 class="accordion-header" id="headingSim">
                    <button class="accordion-button"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapseSim"
                            aria-expanded="true"
                            aria-controls="collapseSim">
                      Simulation Configuration
                    </button>
                  </h2>
                  <div id="collapseSim" class="accordion-collapse collapse show" aria-labelledby="headingSim">
                    <div class="accordion-body">
                      {% crispy selection_form %}
                    </div>
                  </div>
                </div>

                <!-- Hyperparameters (independent) -->
                <div class="accordion-item">
                  <h2 class="accordion-header" id="headingHyper">
                    <button class="accordion-button"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapseHyper"
                            aria-expanded="true"
                            aria-controls="collapseHyper">
                      Hyperparameters
                    </button>
                  </h2>
                  <div id="collapseHyper" class="accordion-collapse collapse show" aria-labelledby="headingHyper">
                    <div class="accordion-body">
                      {% crispy hyper_form %}
                    </div>
                  </div>
                </div>

                <!-- Yuma Parameters (independent) -->
                <div class="accordion-item">
                  <h2 class="accordion-header" id="headingYuma">
                    <button class="accordion-button"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapseYuma"
                            aria-expanded="true"
                            aria-controls="collapseYuma">
                      Yuma Parameters
                    </button>
                  </h2>
                  <div id="collapseYuma" class="accordion-collapse collapse show" aria-labelledby="headingYuma">
                    <div class="accordion-body">
                      {% crispy yuma_form %}
                      <script>
                        document.addEventListener('DOMContentLoaded', () => {
                          const liquidCheckbox = document.getElementById('id_liquid_alpha');
                          const bondFieldset   = document.querySelectorAll('.bond-liquid-group');
                          const alphaGroup     = document.querySelectorAll('.alpha-params-group');
                          const decayGroup     = document.querySelectorAll('.decay-capacity-group');
                          const yumaSelect     = document.getElementById('id_selected_yumas');
                          const bondInput      = document.getElementById('id_bond_moving_avg');
                          const specialKeys    = ['YUMA2C'];
                        
                          function updateLiquidVisibility() {
                            const showAlpha = liquidCheckbox.checked;
                            alphaGroup.forEach(el => el.style.display = showAlpha ? 'flex' : 'none');
                            bondInput.classList.toggle('fake-disabled', showAlpha);
                          }
                        
                          function updateYuma() {
                            const val = yumaSelect.value;
                            const isY1 = (val === 'YUMA1');
                        
                            if (specialKeys.includes(val)) {
                              bondFieldset.forEach(el => el.style.display = 'none');
                              alphaGroup.forEach(el => el.style.display = 'none');
                              decayGroup.forEach(el => el.style.display = 'flex');
                            } else {
                              bondFieldset.forEach(el => el.style.display = 'flex');
                              decayGroup.forEach(el => el.style.display = 'none');
                              updateLiquidVisibility();
                            }
                        
                            if (isY1) {
                              bondInput.value    = 0;
                              bondInput.readOnly = true;
                              bondInput.required = false;
                              bondInput.classList.add('fake-disabled');
                            } else {
                              bondInput.readOnly = false;
                              bondInput.required = true;
                              bondInput.classList.remove('fake-disabled');
                            }
                          }
                        
                          liquidCheckbox.addEventListener('change', updateLiquidVisibility);
                          yumaSelect.addEventListener('change', updateYuma);
                        
                          updateYuma();
                        });
                        </script>
                    </div>
                  </div>
                </div>

              </div>

            </form>
          </div>
          <div class="card-footer bg-light">
            <!-- full-width generate button -->
            <button type="submit"
                    id="generateBtnFooter"
                    form="simulationForm"
                    class="btn btn-primary w-100">
              Generate
            </button>
          </div>
        </div>
      </aside>

      <!-- Results Panel -->
      <section id="results" class="col-12 col-md-8 col-lg-9 mb-4">
        <div class="card shadow-sm h-100">
          <div id="resultsHeader" class="card-header d-flex justify-content-between align-items-center"
               style="position: sticky; top: 0; z-index: 10; background: #f5f5f5;">
            <div class="d-flex align-items-center">
              <!-- collapse/unfold toggle if visible -->
              <button class="res-toggle btn btn-sm btn-outline-secondary me-2 d-none"
                      aria-label="Toggle sidebar">
                <i class="bi bi-chevron-right"></i>
              </button>
              <h5 class="mb-0">Charts</h5>
            </div>

            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" role="switch"
                     id="colSwitch">
              <label class="form-check-label" for="colSwitch">
                One column
              </label>
            </div>

          </div>
          <div class="card-body p-0">
              <div id="chartWrapper" class="p-4">
                {% if valid_forms %}
                  <div class="text-center">
                    <div class="spinner-border" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                  </div>
                {% else %}
                  <p class="text-muted">No results yet. Select options and hit Generate.</p>
                {% endif %}
              </div>
          </div>
        </div>
      </section>

      <script>
        const singleUrl    = "{% url 'simulate_single_case' %}";
        const metagraphUrl = "{% url 'metagraph_simulation' %}";
      
        const useMetagraphEl = document.getElementById('id_use_metagraph');
        const startBlockEl   = document.getElementById('id_start_block');
        const epochsNumEl    = document.getElementById('id_epochs_num');
        const netuidEl       = document.getElementById('id_netuid');
        const validatorsEl   = document.getElementById('id_validators');
        const minersEl = document.getElementById('id_miners');
      
        const validForms    = ("{{ valid_forms|yesno:'true,false' }}" === "true");
        const selectedCases = JSON.parse('{{ cases_json|escapejs }}');
        const yumasData     = JSON.parse('{{ yumas_json|escapejs }}');

        const simForm = document.getElementById('simulationForm');

        window.addEventListener("load", () => 
          validForms && fetchAllCasesParallel()
        );
      
        function parseCaseNumber(caseName) {
          const m = caseName.match(/^Case\s+(\d+)/i);
          return m ? parseInt(m[1],10) : 999999;
        }
        
        async function fetchAllCasesParallel() {
          const chartWrapper = document.getElementById("chartWrapper");

          // toggle metagraph styling
          if (useMetagraphEl.checked) chartWrapper.classList.add("metagraph");
          else                     chartWrapper.classList.remove("metagraph");

          // show spinner while loading
          chartWrapper.innerHTML = `
            <div class="text-center">
              <div class="spinner-border" role="status"></div>
            </div>`;

          const simParams = yumasData.sim_params;
          const yParams   = yumasData.yuma_params;

          if (useMetagraphEl.checked) {
            // ─── metagraph call ────────────────────────────────────────────
            const url = new URL(metagraphUrl, window.location.origin);
            // set all params
            url.searchParams.set("kappa",                       simParams.kappa);
            url.searchParams.set("bond_penalty",                simParams.bond_penalty);
            url.searchParams.set("reset_bonds",                 simParams.reset_bonds);
            url.searchParams.set("liquid_alpha_consensus_mode", simParams.liquid_alpha_consensus_mode);
            url.searchParams.set("selected_yumas",              yumasData.selected_yuma_key);
            url.searchParams.set("bond_moving_avg",             yParams.bond_moving_avg);
            url.searchParams.set("liquid_alpha",                yParams.liquid_alpha);
            url.searchParams.set("alpha_high",                  yParams.alpha_high);
            url.searchParams.set("alpha_low",                   yParams.alpha_low);
            url.searchParams.set("decay_rate",                  yParams.decay_rate);
            url.searchParams.set("capacity_alpha",              yParams.capacity_alpha);
            url.searchParams.set("alpha_sigmoid_steepness",     yParams.alpha_sigmoid_steepness);
            url.searchParams.set("start_block",                 startBlockEl.value);
            url.searchParams.set("epochs_num",                  epochsNumEl.value);
            url.searchParams.set("netuid",                      netuidEl.value);
            url.searchParams.set("validators",                  validatorsEl.value);
            url.searchParams.set("miners",    minersEl.value);

            try {
              const res  = await fetch(url);
              const html = await res.text();
              if (!res.ok) {
                // server‐side validation error (e.g. bad block range or invalid validators)
                chartWrapper.innerHTML = `<div style="color:red;">${html}</div>`;
              } else {
                chartWrapper.innerHTML = `
                  <div class="card shadow case-container mb-4">
                    <div class="card-header"><strong>Metagraph Simulation</strong></div>
                    <div class="card-body p-3">${html}</div>
                  </div>`;
              }
            } catch (err) {
              chartWrapper.innerHTML = `<div style="color:red;">Error: ${err.message}</div>`;
            }

          } else {
            // ─── N single-case calls ────────────────────────────────────────
            const sortedCases = [...selectedCases].sort((a, b) => {
              const na = parseInt(a.match(/^Case\s+(\d+)/i)?.[1] || "0", 10);
              const nb = parseInt(b.match(/^Case\s+(\d+)/i)?.[1] || "0", 10);
              return na - nb;
            });

            const promises = sortedCases.map(caseName => {
              const url = new URL(singleUrl, window.location.origin);
              url.searchParams.set("case_name",                   caseName);
              url.searchParams.set("kappa",                       simParams.kappa);
              url.searchParams.set("bond_penalty",                simParams.bond_penalty);
              url.searchParams.set("reset_bonds",                 simParams.reset_bonds);
              url.searchParams.set("liquid_alpha_consensus_mode", simParams.liquid_alpha_consensus_mode);
              url.searchParams.set("chosen_yuma",                 yumasData.chosen_yuma);
              url.searchParams.set("bond_moving_avg",             yParams.bond_moving_avg);
              url.searchParams.set("liquid_alpha",                yParams.liquid_alpha);
              url.searchParams.set("alpha_high",                  yParams.alpha_high);
              url.searchParams.set("alpha_low",                   yParams.alpha_low);
              url.searchParams.set("decay_rate",                  yParams.decay_rate);
              url.searchParams.set("capacity_alpha",              yParams.capacity_alpha);
              url.searchParams.set("alpha_sigmoid_steepness",     yParams.alpha_sigmoid_steepness);

              return fetch(url)
                .then(r => { if (!r.ok) throw new Error(r.statusText); return r.text(); })
                .then(html => ({
                  snippet: `
                    <div class="card shadow case-container mb-4">
                      <div class="card-header"><strong>${caseName}</strong></div>
                      <div class="card-body p-3">${html}</div>
                    </div>`
                }))
                .catch(err => ({
                  snippet: `<div style="color:red;">Error on '${caseName}': ${err.message}</div>`
                }));
            });

            const results = await Promise.all(promises);
            chartWrapper.innerHTML = "";
            results.forEach(r => chartWrapper.insertAdjacentHTML("beforeend", r.snippet));
          }
        }
      
        $(function(){
          $('.selectpicker').selectpicker('destroy').selectpicker({ container: 'body', dropupAuto: false });
        });
      
        document.addEventListener("DOMContentLoaded", () => {
          // column-switch retention
          const switchEl = document.getElementById('colSwitch');
          const wrapper  = document.getElementById('chartWrapper');
          const KEY = 'forceOneColumn';
          if (localStorage.getItem(KEY) === 'true') {
            switchEl.checked = true;
            wrapper.classList.add('force-one');
          }
          switchEl.addEventListener('change', () => {
            if (switchEl.checked) wrapper.classList.add('force-one');
            else wrapper.classList.remove('force-one');
            localStorage.setItem(KEY, switchEl.checked);
          });
        });
      </script>
      

<script>
  const sidebar = document.getElementById('sidebar');
  const results = document.getElementById('results');
  const simBtn  = document.querySelector('.sim-toggle');
  const resBtn  = document.querySelector('.res-toggle');

  function toggleSidebar() {
    const isCollapsed = sidebar.classList.toggle('collapsed');


    // 2) resBtn: on collapse → show on md+, on expand → hide everywhere
    if (isCollapsed) {
      resBtn.classList.remove('d-none');
      resBtn.classList.add('d-md-inline');
    } else {
      resBtn.classList.add('d-none');
      resBtn.classList.remove('d-md-inline');
    }

    // 3) Swap icons
    simBtn.querySelector('i').className = isCollapsed
      ? 'bi bi-chevron-right'
      : 'bi bi-chevron-left';

    // 4) Expand/shrink results panel on md+ only
    if (isCollapsed) {
      results.classList.replace('col-md-8', 'col-md-12');
      results.classList.replace('col-lg-9', 'col-lg-12');
    } else {
      results.classList.replace('col-md-12', 'col-md-8');
      results.classList.replace('col-lg-12', 'col-lg-9');
    }
  }

  simBtn.addEventListener('click', toggleSidebar);
  resBtn.addEventListener('click', toggleSidebar);
</script>
<script>
  document
    .querySelectorAll('[data-bs-toggle="tooltip"]')
    .forEach(el => {
      new bootstrap.Tooltip(el, {
        trigger: 'hover',    // only on mouse-over, never on focus
        container: 'body'    // same as your attr, keeps it out of overflow:hidden
      });
    });
</script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    // list of fields to normalize
    const configs = [
      { id: 'id_kappa'           , defaultMax: 65535    },
      { id: 'id_bond_penalty'    , defaultMax: 65535    },
      { id: 'id_bond_moving_avg' , defaultMax: 1000000  }
    ];
  
    configs.forEach(({id, defaultMax}) => {
      const input = document.getElementById(id);
      const label = document.querySelector(`label[for="${id}"]`);
      if (!input || !label) return;
  
      const MAX = parseFloat(input.max) || defaultMax;
      const scaled = document.createElement('small');
      scaled.id = `${id}_scaled`;
      scaled.className = 'text-muted ms-2';
      label.appendChild(scaled);
  
      function refresh() {
        const v = parseFloat(input.value) || 0;
        scaled.textContent = `(${(v / MAX).toFixed(4)})`;
      }
  
      input.addEventListener('input', refresh);
      refresh();
    });
  });
</script>
<script>
  function updateMetagraphToggle() {
    const on = document.getElementById("id_use_metagraph").checked;
    document.getElementById("block_standard")
            .classList.toggle("d-none", on);
    document.getElementById("metagraph_params")
            .classList.toggle("d-none", !on);
    document
            .getElementById("row_reset_bonds")
            .classList.toggle("d-none", on);
  }

  document.addEventListener("DOMContentLoaded", () => {
    const cb = document.getElementById("id_use_metagraph");
    cb.addEventListener("change", updateMetagraphToggle);
    updateMetagraphToggle();
  });
</script>
</body>
</html>
