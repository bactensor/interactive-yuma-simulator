{% load crispy_forms_tags %}

<!DOCTYPE html>
<html>
<head>
  <title>Yuma Simulation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.min.js" integrity="sha384-VQqxDN0EQCkWoxt/0vsQvZswzTHUVOImccYmSyhJTp7kGtPed0Qcx8rK9h9YEgx+" crossorigin="anonymous"></script>
</head>
<style>
/* Always hide form body on collapse */
#sidebar.collapsed .card-body {
  display: none !important;
}

/* On md+ screens, fully hide the sidebar when collapsed */
@media (min-width: 768px) {
  #sidebar.collapsed {
    display: none !important;
  }
}

/* Hide the “res-toggle” button by default */
.res-toggle {
  display: none !important;
}

/* On medium+ screens, show it only when the sidebar has the .collapsed class */
@media (min-width: 768px) {
  /* Assuming #sidebar and #results are siblings */
  #sidebar.collapsed + #results .res-toggle {
    display: inline-block !important;
  }
}

/* Make both toggles tiny so they don’t affect header height */
.sim-toggle,
.res-toggle {
  padding: 0.25rem !important;   /* minimal clickable area */
  width: 1.5rem;                 /* square button */
  height: 1.5rem;
  line-height: 1;                /* icon centers nicely */
  font-size: 1rem;               /* icon size */
}

/* If you want zero extra padding */
.sim-toggle,
.res-toggle {
  padding: 0 !important;
}

/* Optionally, use flex centering in case */
.sim-toggle i,
.res-toggle i {
  display: block;
  margin: auto;
}
</style>
<body>

  <div class="container-fluid">
    <div class="row gx-3">

      <!-- Input Panel -->
      <aside id="sidebar" class="col-12 col-md-4 col-lg-3 mb-4">
        <div class="card h-100">
          <div class="card-header d-flex align-items-center justify-content-between"
               style="position: sticky; top: 0; z-index: 10; background: #fff;">
            <h5 class="mb-0">Yuma Simulation</h5>
            <!-- sim-toggle: always visible on small, only on md+ when expanded -->
            <button type="button"
                    class="sim-toggle btn btn-sm btn-outline-secondary"
                    aria-label="Toggle sidebar">
              <i class="bi bi-chevron-left"></i>
            </button>
          </div>
          <div class="card-body p-3">
            <form method="get" novalidate>
              {% crispy selection_form %}
              <div class="row">
                <div class="col-12 col-lg-6 mb-3">
                  {% crispy hyper_form %}
                </div>
                <div class="col-12 col-lg-6 mb-3">
                  {% crispy yuma_form %}
                </div>
              </div>
              <button type="submit" class="btn btn-primary btn-lg w-100">Generate</button>
            </form>
          </div>
        </div>
      </aside>

      <!-- Results Panel -->
      <section id="results" class="col-12 col-md-8 col-lg-9 mb-4">
        <div class="card h-100">
          <div class="card-header d-flex align-items-center"
               style="position: sticky; top: 0; z-index: 10; background: #fff;">
            <!-- res-toggle: hidden initially, only shown on md+ when collapsed -->
            <button type="button"
                    class="res-toggle btn btn-sm btn-outline-secondary d-none me-2"
                    aria-label="Toggle sidebar">
              <i class="bi bi-chevron-right"></i>
            </button>
            <h5 class="mb-0">Results</h5>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive" style="height: calc(100vh - 200px); overflow:auto;">
              <div id="chartWrapper" class="p-3">
                {% if valid_forms %}
                  <p>Loading charts…</p>
                {% else %}
                  <p class="text-muted">No results yet. Select options and hit Generate.</p>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </section>

  <script>
    // function updateArrowPosition() {
    //   const container = document.getElementById("main-container");
    //   const toggleBtn = document.getElementById("toggleBtn");
    //   const containerRect = container.getBoundingClientRect();
    //   if (!container.classList.contains("collapsed")) {
    //     const newLeft = containerRect.left + 20 + ((containerRect.width - 40) * 0.3);
    //     toggleBtn.style.left = newLeft + "px";
    //   } else {
    //     const newLeft = containerRect.left + 20;
    //     toggleBtn.style.left = newLeft + "px";
    //   }
    // }
    
    // function togglePanel() {
    //   const container = document.getElementById("main-container");
    //   const toggleBtn = document.getElementById("toggleBtn");
    //   if (container.classList.contains("collapsed")) {
    //     container.classList.remove("collapsed");
    //     toggleBtn.innerHTML = "&#9664;";
    //   } else {
    //     container.classList.add("collapsed");
    //     toggleBtn.innerHTML = "&#9654;";
    //   }
    //   updateArrowPosition();
    // }
    
    // window.addEventListener("load", updateArrowPosition);
    // window.addEventListener("resize", updateArrowPosition);

    // Convert valid_forms to a boolean
    const validFormsString = "{{ valid_forms|yesno:'true,false' }}";
    const validForms = (validFormsString === "true");

    // Parse as JSON
    const selectedCases = JSON.parse('{{ cases_json|escapejs }}');
    const yumasData = JSON.parse('{{ yumas_json|escapejs }}');

    function parseCaseNumber(caseName) {
      const match = caseName.match(/^Case\s+(\d+)/i);
      return match ? parseInt(match[1], 10) : 999999;
    }

    window.addEventListener("load", () => {
      if (validForms) {
        fetchAllCasesParallel();
      }
    });

    async function fetchAllCasesParallel() {
      const chartWrapper = document.getElementById("chartWrapper");
      chartWrapper.innerHTML = "";

      const sortedCases = [...selectedCases].sort((a, b) =>
        parseCaseNumber(a) - parseCaseNumber(b)
      );

      const simParams = yumasData.sim_params || {};
      const yumaParams = yumasData.yuma_params || {};

      const fetchPromises = sortedCases.map(caseName => {
        const url = new URL("{% url 'simulate_single_case' %}", window.location.origin);
        url.searchParams.set("case_name", caseName);
        url.searchParams.set("kappa", simParams.kappa);
        url.searchParams.set("bond_penalty", simParams.bond_penalty);
        url.searchParams.set("reset_bonds", simParams.reset_bonds);
        url.searchParams.set("liquid_alpha_consensus_mode", simParams.liquid_alpha_consensus_mode);
        url.searchParams.set("selected_yuma_key", yumasData.selected_yuma_key);
        url.searchParams.set("chosen_yuma", yumasData.chosen_yuma);
        url.searchParams.set("bond_moving_avg", yumaParams.bond_moving_avg);
        url.searchParams.set("liquid_alpha", yumaParams.liquid_alpha);
        url.searchParams.set("alpha_high", yumaParams.alpha_high);
        url.searchParams.set("alpha_low", yumaParams.alpha_low);
        url.searchParams.set("decay_rate", yumaParams.decay_rate);
        url.searchParams.set("capacity_alpha", yumaParams.capacity_alpha);
        url.searchParams.set("alpha_sigmoid_steepness", yumaParams.alpha_sigmoid_steepness);
        if (yumaParams.override_consensus_high !== null) {
          url.searchParams.set("override_consensus_high", yumaParams.override_consensus_high);
        }
        if (yumaParams.override_consensus_low !== null) {
          url.searchParams.set("override_consensus_low", yumaParams.override_consensus_low);
        }

        return fetch(url)
          .then(res => {
            if (!res.ok) throw new Error(`Status ${res.status}`);
            return res.text();
          })
          .then(html => {
            const safeId = caseName.replace(/\s+/g, "_");
            return {
              snippet: `
                <div class="case-container" id="container_for_${safeId}">
                  ${html}
                </div>
              `
            };
          })
          .catch(err => ({ snippet: `<div style="color:red;">Error fetching '${caseName}': ${err.message}</div>` }));
      });

      const results = await Promise.all(fetchPromises);

      for (const { snippet } of results) {
        chartWrapper.insertAdjacentHTML("beforeend", snippet);
      }
    }

  </script>

<script>
  const sidebar = document.getElementById('sidebar');
  const results = document.getElementById('results');
  const simBtn  = document.querySelector('.sim-toggle');
  const resBtn  = document.querySelector('.res-toggle');

  function toggleSidebar() {
    const isCollapsed = sidebar.classList.toggle('collapsed');


    // 2) resBtn: on collapse → show on md+, on expand → hide everywhere
    if (isCollapsed) {
      resBtn.classList.remove('d-none');
      resBtn.classList.add('d-md-inline');
    } else {
      resBtn.classList.add('d-none');
      resBtn.classList.remove('d-md-inline');
    }

    // 3) Swap icons
    simBtn.querySelector('i').className = isCollapsed
      ? 'bi bi-chevron-right'
      : 'bi bi-chevron-left';

    // 4) Expand/shrink results panel on md+ only
    if (isCollapsed) {
      results.classList.replace('col-md-8', 'col-md-12');
      results.classList.replace('col-lg-9', 'col-lg-12');
    } else {
      results.classList.replace('col-md-12', 'col-md-8');
      results.classList.replace('col-lg-12', 'col-lg-9');
    }
  }

  simBtn.addEventListener('click', toggleSidebar);
  resBtn.addEventListener('click', toggleSidebar);
</script>
</body>
</html>
